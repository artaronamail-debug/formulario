<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Dante Propiedades</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .panel {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .contacts-table th,
        .contacts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .contacts-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }
        
        .contacts-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .warning {
            background: #fff3e0;
            color: #f57c00;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .refresh-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .export-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* Estilo espec√≠fico para el bot√≥n de Excel */
        .export-btn[onclick*="exportarExcel"] {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .export-btn[onclick*="exportarExcel"]:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
        }
        
        @media (max-width: 768px) {
            .actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .contacts-table {
                font-size: 0.9em;
            }
            
            .contacts-table th,
            .contacts-table td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Panel de Administraci√≥n</h1>
            <p>Dante Propiedades - Sistema de Contactos Dual</p>
            <p style="font-size: 0.9em; margin-top: 5px;">localStorage + Backend Local</p>
        </div>
        
        <div class="panel">
            <div class="stats-grid" id="statsGrid">
                <div class="loading">Cargando estad√≠sticas...</div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" onclick="cargarDatos()">
                    üîÑ Actualizar Datos
                </button>
                <button class="btn btn-success" onclick="iniciarBackend()">
                    üöÄ Iniciar Backend Local
                </button>
                <button class="btn btn-danger" onclick="limpiarDatos()">
                    üóëÔ∏è Limpiar LocalStorage
                </button>
                <button class="btn refresh-btn" onclick="verificarConexion()">
                    üîç Verificar Estado
                </button>
            </div>
            
            <div id="status"></div>
        </div>
        
        <div class="panel">
            <h2>üìã Lista de Contactos</h2>
            <div id="contactsContainer">
                <div class="loading">Cargando contactos...</div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // SISTEMA DUAL: localStorage + Backend Opcional
        // ========================================
        
        // Configuraci√≥n de fuentes de datos
        const CONFIG = {
            localStorage: {
                key: 'consultas_contacto',
                enabled: true
            },
            backend: {
                url: 'http://localhost:5000',
                enabled: false  // Se activa si el backend est√° disponible
            }
        };
        
        // Verificar disponibilidad de datos localStorage
        function verificarDatosLocal() {
            try {
                const data = localStorage.getItem(CONFIG.localStorage.key);
                return data ? JSON.parse(data) : [];
            } catch (error) {
                console.error('Error leyendo localStorage:', error);
                return [];
            }
        }

        
        // Verificar conexi√≥n (solo localStorage - sin backend autom√°tico)
        function verificarConexion() {
            const localData = verificarDatosLocal();
            const statusDiv = document.getElementById('status');
            
            // Solo verificar localStorage (sin backend autom√°tico)
            if (localData.length > 0) {
                statusDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Sistema funcionando correctamente<br>
                        üìä Datos locales: ${localData.length} contactos<br>
                        üì° Fuente: localStorage<br>
                        üí° Para verificar backend: usa el bot√≥n "üîç Verificar Estado"<br>
                        üìÖ Verificado: ${new Date().toLocaleString('es-AR')}
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="warning">
                        ‚ö†Ô∏è Sin datos locales a√∫n<br>
                        üìã El formulario crear√° datos al usarse<br>
                        üí° Sistema preparado para recibir contactos<br>
                        üîß Para usar backend: ejecutar sistema-formularios-backend-app.py
                    </div>
                `;
            }
        }
        
        // Calcular estad√≠sticas desde localStorage
        function calcularEstadisticas(contactos) {
            const hoy = new Date().toDateString();
            const hoyContactos = contactos.filter(c => new Date(c.timestamp).toDateString() === hoy);
            const ultimoContacto = contactos.length > 0 ? 
                new Date(Math.max(...contactos.map(c => new Date(c.timestamp)))) : null;
            
            return {
                total_contactos: contactos.length,
                contactos_hoy: hoyContactos.length,
                ultimo_contacto: ultimoContacto ? ultimoContacto.toLocaleDateString('es-AR') : 'N/A',
                formularios_recibidos: contactos.length,
                fuente: CONFIG.backend.enabled ? 'Backend' : 'localStorage'
            };
        }
        
        // Cargar datos (localStorage + Backend si disponible)
        async function cargarDatos() {
            const statsGrid = document.getElementById('statsGrid');
            const contactsContainer = document.getElementById('contactsContainer');
            
            // Siempre cargar desde localStorage
            const contactosLocal = verificarDatosLocal();
            const statsLocal = calcularEstadisticas(contactosLocal);
            
            // Intentar cargar desde backend si est√° disponible
            if (CONFIG.backend.enabled) {
                try {
                    const response = await fetch(`${CONFIG.backend.url}/api/estadisticas`);
                    if (response.ok) {
                        const data = await response.json();
                        // Usar datos del backend
                        statsLocal.total_contactos = Math.max(statsLocal.total_contactos, data.total_contactos || 0);
                        statsLocal.formularios_recibidos = Math.max(statsLocal.formularios_recibidos, data.formularios_recibidos || 0);
                        statsLocal.fuente = 'Backend + localStorage';
                    }
                } catch (error) {
                    console.log('Error con backend, usando solo localStorage:', error);
                }
            }
            
            // Mostrar estad√≠sticas
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>${statsLocal.total_contactos}</h3>
                    <p>üìä Total Contactos</p>
                </div>
                <div class="stat-card">
                    <h3>${statsLocal.contactos_hoy}</h3>
                    <p>üìÖ Hoy</p>
                </div>
                <div class="stat-card">
                    <h3>${statsLocal.ultimo_contacto}</h3>
                    <p>üïí √öltimo</p>
                </div>
                <div class="stat-card">
                    <h3>${statsLocal.fuente}</h3>
                    <p>üì° Fuente</p>
                </div>
            `;
            
            // Cargar contactos
            cargarContactos();
        }
        
        // Cargar y mostrar contactos (prioridad: localStorage)
        function cargarContactos() {
            const contactsContainer = document.getElementById('contactsContainer');
            
            // Cargar desde localStorage (siempre funciona)
            const contactosLocal = verificarDatosLocal();
            
            if (contactosLocal.length > 0) {
                let tableHTML = `
                    <div style="margin-bottom: 15px; padding: 15px; background: #f0f8ff; border-radius: 8px; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <span>üìä Mostrando ${contactosLocal.length} contactos desde localStorage</span>
                        <div>
                            <button onclick="exportarDatos()" class="export-btn">
                                üì• Exportar a JSON
                            </button>
                            <button onclick="exportarExcel()" class="export-btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); margin-left: 10px;">
                                üìä Exportar a Excel
                            </button>
                            <button onclick="limpiarDatos()" style="background: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                                üóëÔ∏è Limpiar
                            </button>
                        </div>
                    </div>
                    <table class="contacts-table">
                        <thead>
                            <tr>
                                <th>üìÖ Fecha</th>
                                <th>üë§ Nombre</th>
                                <th>üìß Email</th>
                                <th>üì± Tel√©fono</th>
                                <th>üí¨ Tipo</th>
                                <th>üìù Mensaje</th>
                                <th>üåê Origen</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                contactosLocal.forEach((contacto, index) => {
                    const fecha = new Date(contacto.timestamp).toLocaleString('es-AR');
                    const mensajeCorto = (contacto.mensaje || '').substring(0, 50) + '...';
                    const origen = contacto.pagina_origen || 'Dante Propiedades';
                    const tipo = (contacto.tipo_consulta || 'general').toUpperCase();
                    
                    tableHTML += `
                        <tr>
                            <td style="font-size: 0.85em;">${fecha}</td>
                            <td><strong>${contacto.nombre || 'N/A'}</strong></td>
                            <td style="font-size: 0.85em;">${contacto.email || 'N/A'}</td>
                            <td style="font-size: 0.85em;">${contacto.telefono || 'N/A'}</td>
                            <td><span style="background: #e3f2fd; padding: 2px 6px; border-radius: 3px; font-size: 0.8em;">${tipo}</span></td>
                            <td title="${contacto.mensaje || ''}" style="font-size: 0.85em;">${mensajeCorto}</td>
                            <td style="font-size: 0.8em; color: #666;">${origen}</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                contactsContainer.innerHTML = tableHTML;
            } else {
                contactsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>üì≠ No hay contactos registrados a√∫n.</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            Los datos aparecer√°n aqu√≠ despu√©s de usar el formulario de contacto.
                        </p>
                        <div style="margin-top: 20px;">
                            <button onclick="limpiarDatos()" style="background: #ff6b6b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                                üóëÔ∏è Forzar Limpieza
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para limpiar datos
        function limpiarDatos() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos locales? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem(CONFIG.localStorage.key);
                cargarContactos();
                document.getElementById('status').innerHTML = `
                    <div class="success">‚úÖ Datos locales eliminados</div>
                `;
            }
        }
        
        // Funci√≥n para exportar datos
        function exportarDatos() {
            const datos = verificarDatosLocal();
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contactos-dante-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Funci√≥n para exportar datos a Excel (CSV)
        function exportarExcel() {
            const datos = verificarDatosLocal();
            
            if (datos.length === 0) {
                alert('‚ö†Ô∏è No hay datos para exportar.');
                return;
            }
            
            // Crear encabezado CSV
            const encabezados = ['Fecha', 'Hora', 'Nombre', 'Email', 'Tel√©fono', 'Tipo de Consulta', 'Mensaje', 'Origen'];
            
            // Convertir datos a filas CSV
            const filas = datos.map(contacto => {
                const fecha = new Date(contacto.timestamp).toLocaleString('es-AR');
                const partes = fecha.split(' ');
                const fechaSolo = partes[0];
                const horaSolo = partes[1];
                
                return [
                    fechaSolo,                                    // Fecha
                    horaSolo,                                     // Hora
                    (contacto.nombre || '').replace(/,/g, ';'),   // Nombre (reemplazar comas)
                    (contacto.email || '').replace(/,/g, ';'),    // Email
                    (contacto.telefono || '').replace(/,/g, ';'), // Tel√©fono
                    (contacto.tipo_consulta || 'general').toUpperCase(), // Tipo
                    (contacto.mensaje || '').replace(/,/g, ';'),  // Mensaje
                    (contacto.pagina_origen || 'Dante Propiedades').replace(/,/g, ';') // Origen
                ];
            });
            
            // Combinar encabezados y datos
            const csvContent = [encabezados, ...filas]
                .map(fila => fila.join(','))
                .join('\n');
            
            // Crear y descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contactos-dante-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Mostrar confirmaci√≥n
            alert(`‚úÖ ¬°Excel exportado correctamente!\nüìä Registros exportados: ${datos.length}\nüìÅ Archivo: contactos-dante-${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        // Funci√≥n para iniciar backend
        function iniciarBackend() {
            const instrucciones = `
üöÄ INSTRUCCIONES PARA INICIAR EL BACKEND:

1Ô∏è‚É£ Prerrequisitos:
   ‚Ä¢ Python instalado en tu sistema
   ‚Ä¢ Acceso a terminal/l√≠nea de comandos

2Ô∏è‚É£ Ejecutar servidor:
   python sistema-formularios-backend-app.py
   (o: python3 sistema-formularios-backend-app.py)

3Ô∏è‚É£ El servidor se ejecutar√° en:
   http://localhost:5000

4Ô∏è‚É£ Funciones del backend:
   ‚Ä¢ Almacena datos en Excel/CSV
   ‚Ä¢ Respaldos autom√°ticos
   ‚Ä¢ Estad√≠sticas en tiempo real
   ‚Ä¢ Exportaci√≥n de archivos

5Ô∏è‚É£ Para conectar con el formulario:
   El sistema integrado ya est√° configurado para usar el backend si est√° disponible.

üí° NOTA: Si el backend no est√° corriendo, el sistema usar√° localStorage autom√°ticamente.
            `;
            alert(instrucciones);
        }
        
        // Verificar conexi√≥n espec√≠fica del backend (para botones)
        function verificarBackend() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = '<div class="loading">Verificando backend local...</div>';
            
            // Verificar backend manualmente (solo cuando el usuario lo solicita)
            fetch(`${CONFIG.backend.url}/health`, {
                timeout: 5000 // Timeout de 5 segundos para verificaci√≥n manual
            })
            .then(response => {
                if (response.ok) {
                    CONFIG.backend.enabled = true;
                    statusDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Backend local disponible<br>
                            üìç Usando servidor: ${CONFIG.backend.url}<br>
                            üìÖ Verificado: ${new Date().toLocaleString('es-AR')}<br>
                            üí° Ahora el sistema puede usar el backend para estad√≠sticas avanzadas
                        </div>
                    `;
                } else {
                    throw new Error('Backend no responde');
                }
            })
            .catch(error => {
                CONFIG.backend.enabled = false;
                statusDiv.innerHTML = `
                    <div class="warning">
                        ‚ö†Ô∏è Backend no disponible<br>
                        üìç Usando datos locales (localStorage)<br>
                        üí° Para usar backend: ejecutar sistema-formularios-backend-app.py
                    </div>
                `;
            });
        }

        // Verificar conexi√≥n al cargar la p√°gina (solo localStorage)
        window.addEventListener('load', () => {
            console.log('üè¢ Panel de Administraci√≥n - Sistema Dual cargando...');
            // Cargar datos localStorage inmediatamente (sin backend autom√°tico)
            cargarDatos();
            verificarConexion();
        });
        
        // Actualizar cada 30 segundos (solo si hay datos)
        setInterval(() => {
            const datos = verificarDatosLocal();
            if (datos.length > 0) {
                cargarDatos();
            }
        }, 30000);
    </script>
</body>
</html>